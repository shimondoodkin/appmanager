// dojo save - make dojo work fast. by combining all modules into one.

// many urls , same data. so we won't save same large data many times rather save it's hash.
var savedojo_url={};//  - pages  and its data md5 as data id
var savedojo_data={};//  - data by md5 sum of input
var md5= function(data){var h=require('crypto').createHash('md5');h.update(data);return h.digest('hex');};

function savedojo_makeset(host,url,md5val,bodyobj)
{
    savedojo_url[url]=md5val;
    var all=fs.readFileSync('savedojo_preloaded.js')+"\r\ndojo._preloadedUri={\r\n",file="",text="";
    for(var i=0;i<bodyobj.length;i++) 
    {
     var o=bodyobj[i];
     file=__dirname+'/node_modules'+(urlparse(urlresolve('http://'+host,o.f), true).pathname); // unsecure path should be urlresolve d before use
     if(checkfile(file))
     {
      text=fs.readFileSync(file).toString();
      //from dojo._loadUri
      if(o.cb)
      {
       text=/^define\(/.test(text)?text:"("+text+")";                                      // was parsed as var x=eval("(  {json:here}  )")
       all+=(i>0?',':'')+JSON.stringify(o.f)+':\r\n function(){return '+text+'} \r\n\r\n'; // various json objects. made it afunction so it will be simular to the second.
      }
      else
      {
        text='function(){'+(o.pf?o.pf:'')+text+(o.sf?o.sf:'')+'}';                       // was executed inside eval(...).
        all+=(i>0?',':'')+JSON.stringify(o.f)+':\r\n'+text+'\r\n\r\n';                   // a return is expected inside the code.         
      }
     }
    }
    all+="};";
    savedojo_data[md5val]=all;
}
function savedojo(req,url,q,send)
{
 url=url.substr(url.indexOf('/',8));
 if(req.method=='POST')//save files to cache and return ok
 {
  var body = '';
  req.on('data', function (data){body += data;});
  req.on('end', function ()
  {
   var bodyhash=md5(body);
   if(!savedojo_data[bodyhash])
   {
    console.log('dojo preloaded set saved');
    savedojo_makeset(req.headers.host,url,bodyhash,JSON.parse(body));
    console.log("\r\n add this to file to auto preload: \r\n savedojo_makeset('"+req.headers.host+"','"+url+"','"+bodyhash+"',"+body+");\r\n");
   }
   else 
    console.log('dojo preloaded set - already  saved, url='+url);
  });
 }
 else
 {
  if(savedojo_url[url]) { send(savedojo_data[savedojo_url[url]],'text/javascript',false,etag); }
  else                  { send(fs.readFileSync('savedojo.js'),'text/javascript');   }
 }
 //var data=q.data?q.data:[];
 //req.headers.referrer
}
// preload sets:
//savedojo_makeset('vot.me:2222','/','440e473a580316648f02399fadbd32a1',[{"f":"/dojo/1.6.1/dojo/../dojox/data/JsonRestStore.js","cb":false},{"f":"/dojo/1.6.1/dojo/../dojox/rpc/JsonRest.js","cb":false},{"f":"/dojo/1.6.1/dojo/../dojox/json/ref.js","cb":false},{"f":"/dojo/1.6.1/dojo/./date/stamp.js","cb":false},{"f":"/dojo/1.6.1/dojo/../dojox/rpc/Rest.js","cb":false},{"f":"/dojo/1.6.1/dojo/../dojox/data/ServiceStore.js","cb":false},{"f":"/dojo/1.6.1/dojo/../dijit/Tree.js","cb":false},{"f":"/dojo/1.6.1/dojo/./fx.js","cb":false},{"f":"/dojo/1.6.1/dojo/./fx/Toggler.js","cb":false},{"f":"/dojo/1.6.1/dojo/./DeferredList.js","cb":false},{"f":"/dojo/1.6.1/dojo/../dijit/_Widget.js","cb":false},{"f":"/dojo/1.6.1/dojo/../dijit/_WidgetBase.js","cb":false},{"f":"/dojo/1.6.1/dojo/../dijit/_base/manager.js","cb":false},{"f":"/dojo/1.6.1/dojo/./Stateful.js","cb":false},{"f":"/dojo/1.6.1/dojo/../dijit/_base.js","cb":false},{"f":"/dojo/1.6.1/dojo/../dijit/_base/focus.js","cb":false},{"f":"/dojo/1.6.1/dojo/./window.js","cb":false},{"f":"/dojo/1.6.1/dojo/../dijit/_base/place.js","cb":false},{"f":"/dojo/1.6.1/dojo/./AdapterRegistry.js","cb":false},{"f":"/dojo/1.6.1/dojo/../dijit/_base/popup.js","cb":false},{"f":"/dojo/1.6.1/dojo/../dijit/_base/window.js","cb":false},{"f":"/dojo/1.6.1/dojo/../dijit/_base/scroll.js","cb":false},{"f":"/dojo/1.6.1/dojo/../dijit/_base/sniff.js","cb":false},{"f":"/dojo/1.6.1/dojo/./uacss.js","cb":false},{"f":"/dojo/1.6.1/dojo/../dijit/_base/typematic.js","cb":false},{"f":"/dojo/1.6.1/dojo/../dijit/_base/wai.js","cb":false},{"f":"/dojo/1.6.1/dojo/../dijit/_Templated.js","cb":false},{"f":"/dojo/1.6.1/dojo/./string.js","cb":false},{"f":"/dojo/1.6.1/dojo/./parser.js","cb":false},{"f":"/dojo/1.6.1/dojo/./cache.js","cb":false},{"f":"/dojo/1.6.1/dojo/../dijit/_Container.js","cb":false},{"f":"/dojo/1.6.1/dojo/../dijit/_Contained.js","cb":false},{"f":"/dojo/1.6.1/dojo/../dijit/_CssStateMixin.js","cb":false},{"f":"/dojo/1.6.1/dojo/./cookie.js","cb":false},{"f":"/dojo/1.6.1/dojo/./regexp.js","cb":false},{"f":"/dojo/1.6.1/dojo/../dijit/tree/TreeStoreModel.js","cb":false},{"f":"/dojo/1.6.1/dojo/../dijit/tree/ForestStoreModel.js","cb":false},{"f":"/dojo/1.6.1/dojo/../dijit/tree/_dndSelector.js","cb":false},{"f":"/dojo/1.6.1/dojo/./dnd/common.js","cb":false},{"f":"/dojo/1.6.1/dojo/../dijit/tree/_dndContainer.js","cb":false},{"f":"/dojo/1.6.1/dojo/./dnd/Container.js","cb":false},{"f":"/dojo/1.6.1/dojo/../dojox/grid/EnhancedGrid.js","cb":false},{"f":"/dojo/1.6.1/dojo/../dojox/grid/DataGrid.js","cb":false},{"f":"/dojo/1.6.1/dojo/../dojox/grid/nls/DataGrid_he.js","cb":false},{"f":"/dojo/1.6.1/dojo/../dojox/grid/enhanced/_PluginManager.js","cb":false},{"f":"/dojo/1.6.1/dojo/../dojox/grid/enhanced/_Events.js","cb":false},{"f":"/dojo/1.6.1/dojo/../dojox/grid/enhanced/_FocusManager.js","cb":false},{"f":"/dojo/1.6.1/dojo/../dojox/grid/enhanced/nls/he/EnhancedGrid.js","cb":true},{"f":"/dojo/1.6.1/dojo/../dojox/grid/enhanced/plugins/_SelectionPreserver.js","cb":false},{"f":"/dojo/1.6.1/dojo/../dojox/grid/enhanced/plugins/DnD.js","cb":false},{"f":"/dojo/1.6.1/dojo/../dojox/grid/enhanced/_Plugin.js","cb":false},{"f":"/dojo/1.6.1/dojo/../dojox/grid/enhanced/plugins/Selector.js","cb":false},{"f":"/dojo/1.6.1/dojo/../dojox/grid/enhanced/plugins/AutoScroll.js","cb":false},{"f":"/dojo/1.6.1/dojo/../dojox/grid/enhanced/plugins/Rearrange.js","cb":false},{"f":"/dojo/1.6.1/dojo/../dojox/grid/enhanced/plugins/_RowMapLayer.js","cb":false},{"f":"/dojo/1.6.1/dojo/../dojox/grid/enhanced/plugins/_StoreLayer.js","cb":false},{"f":"/dojo/1.6.1/dojo/./dnd/move.js","cb":false},{"f":"/dojo/1.6.1/dojo/../dojox/grid/enhanced/plugins/Menu.js","cb":false},{"f":"/dojo/1.6.1/dojo/../dojox/grid/enhanced/plugins/IndirectSelection.js","cb":false},{"f":"/dojo/1.6.1/dojo/../dojox/grid/cells/dijit.js","cb":false},{"f":"/dojo/1.6.1/dojo/../dijit/form/DateTextBox.js","cb":false},{"f":"/dojo/1.6.1/dojo/../dijit/Calendar.js","cb":false},{"f":"/dojo/1.6.1/dojo/./cldr/supplemental.js","cb":false},{"f":"/dojo/1.6.1/dojo/./date.js","cb":false},{"f":"/dojo/1.6.1/dojo/./date/locale.js","cb":false},{"f":"/dojo/1.6.1/dojo/./cldr/nls/he/gregorian.js","cb":true},{"f":"/dojo/1.6.1/dojo/../dijit/form/DropDownButton.js","cb":false},{"f":"/dojo/1.6.1/dojo/../dijit/form/Button.js","cb":false},{"f":"/dojo/1.6.1/dojo/../dijit/_HasDropDown.js","cb":false},{"f":"/dojo/1.6.1/dojo/../dijit/form/_DateTimeTextBox.js","cb":false},{"f":"/dojo/1.6.1/dojo/../dijit/form/ValidationTextBox.js","cb":false},{"f":"/dojo/1.6.1/dojo/../dijit/form/TextBox.js","cb":false},{"f":"/dojo/1.6.1/dojo/../dijit/Tooltip.js","cb":false},{"f":"/dojo/1.6.1/dojo/../dijit/form/nls/he/validate.js","cb":true},{"f":"/dojo/1.6.1/dojo/../dijit/form/TimeTextBox.js","cb":false},{"f":"/dojo/1.6.1/dojo/../dijit/_TimePicker.js","cb":false},{"f":"/dojo/1.6.1/dojo/../dijit/form/ComboBox.js","cb":false},{"f":"/dojo/1.6.1/dojo/./data/util/simpleFetch.js","cb":false},{"f":"/dojo/1.6.1/dojo/./data/util/sorter.js","cb":false},{"f":"/dojo/1.6.1/dojo/./data/util/filter.js","cb":false},{"f":"/dojo/1.6.1/dojo/../dijit/form/nls/he/ComboBox.js","cb":true},{"f":"/dojo/1.6.1/dojo/./data/ItemFileReadStore.js","cb":false},{"f":"/dojo/1.6.1/dojo/../dijit/form/CheckBox.js","cb":false},{"f":"/dojo/1.6.1/dojo/../dijit/form/ToggleButton.js","cb":false},{"f":"/dojo/1.6.1/dojo/../dijit/form/NumberSpinner.js","cb":false},{"f":"/dojo/1.6.1/dojo/../dijit/form/_Spinner.js","cb":false},{"f":"/dojo/1.6.1/dojo/../dijit/form/NumberTextBox.js","cb":false},{"f":"/dojo/1.6.1/dojo/./number.js","cb":false},{"f":"/dojo/1.6.1/dojo/./cldr/nls/he/number.js","cb":true},{"f":"/dojo/1.6.1/dojo/../dijit/form/CurrencyTextBox.js","cb":false},{"f":"/dojo/1.6.1/dojo/./currency.js","cb":false},{"f":"/dojo/1.6.1/dojo/./cldr/nls/he/currency.js","cb":true},{"f":"/dojo/1.6.1/dojo/./cldr/monetary.js","cb":false},{"f":"/dojo/1.6.1/dojo/../dijit/form/HorizontalSlider.js","cb":false},{"f":"/dojo/1.6.1/dojo/../dijit/Editor.js","cb":false},{"f":"/dojo/1.6.1/dojo/../dijit/_editor/RichText.js","cb":false},{"f":"/dojo/1.6.1/dojo/../dijit/_editor/selection.js","cb":false},{"f":"/dojo/1.6.1/dojo/../dijit/_editor/range.js","cb":false},{"f":"/dojo/1.6.1/dojo/../dijit/_editor/html.js","cb":false},{"f":"/dojo/1.6.1/dojo/../dijit/Toolbar.js","cb":false},{"f":"/dojo/1.6.1/dojo/../dijit/ToolbarSeparator.js","cb":false},{"f":"/dojo/1.6.1/dojo/../dijit/_editor/_Plugin.js","cb":false},{"f":"/dojo/1.6.1/dojo/../dijit/_editor/plugins/EnterKeyHandling.js","cb":false},{"f":"/dojo/1.6.1/dojo/../dijit/_editor/nls/he/commands.js","cb":true},{"f":"/dojo/1.6.1/dojo/../dojox/grid/enhanced/plugins/Filter.js","cb":false},{"f":"/dojo/1.6.1/dojo/../dojox/grid/enhanced/nls/he/Filter.js","cb":true},{"f":"/dojo/1.6.1/dojo/../dojox/grid/enhanced/plugins/Dialog.js","cb":false},{"f":"/dojo/1.6.1/dojo/../dijit/Dialog.js","cb":false},{"f":"/dojo/1.6.1/dojo/./dnd/TimedMoveable.js","cb":false},{"f":"/dojo/1.6.1/dojo/../dijit/form/_FormMixin.js","cb":false},{"f":"/dojo/1.6.1/dojo/../dijit/_DialogMixin.js","cb":false},{"f":"/dojo/1.6.1/dojo/../dijit/DialogUnderlay.js","cb":false},{"f":"/dojo/1.6.1/dojo/../dijit/layout/ContentPane.js","cb":false},{"f":"/dojo/1.6.1/dojo/../dijit/layout/_ContentPaneResizeMixin.js","cb":false},{"f":"/dojo/1.6.1/dojo/./html.js","cb":false},{"f":"/dojo/1.6.1/dojo/../dijit/nls/he/common.js","cb":true},{"f":"/dojo/1.6.1/dojo/../dijit/TooltipDialog.js","cb":false},{"f":"/dojo/1.6.1/dojo/../dojox/grid/enhanced/plugins/filter/FilterLayer.js","cb":false},{"f":"/dojo/1.6.1/dojo/../dojox/grid/enhanced/plugins/filter/_FilterExpr.js","cb":false},{"f":"/dojo/1.6.1/dojo/../dojox/grid/enhanced/plugins/filter/_DataExprs.js","cb":false},{"f":"/dojo/1.6.1/dojo/../dojox/grid/enhanced/plugins/filter/_ConditionExpr.js","cb":false},{"f":"/dojo/1.6.1/dojo/../dojox/grid/enhanced/plugins/filter/FilterBar.js","cb":false},{"f":"/dojo/1.6.1/dojo/../dojox/grid/enhanced/plugins/filter/FilterDefDialog.js","cb":false},{"f":"/dojo/1.6.1/dojo/../dijit/form/Select.js","cb":false},{"f":"/dojo/1.6.1/dojo/../dijit/form/_FormSelectWidget.js","cb":false},{"f":"/dojo/1.6.1/dojo/../dijit/layout/AccordionContainer.js","cb":false},{"f":"/dojo/1.6.1/dojo/../dijit/layout/StackContainer.js","cb":false},{"f":"/dojo/1.6.1/dojo/../dijit/layout/StackController.js","cb":false},{"f":"/dojo/1.6.1/dojo/../dijit/layout/AccordionPane.js","cb":false},{"f":"/dojo/1.6.1/dojo/../dojox/grid/enhanced/plugins/filter/FilterBuilder.js","cb":false},{"f":"/dojo/1.6.1/dojo/../dojox/html/ellipsis.js","cb":false},{"f":"/dojo/1.6.1/dojo/../dojox/grid/enhanced/plugins/filter/FilterStatusTip.js","cb":false},{"f":"/dojo/1.6.1/dojo/../dojox/grid/enhanced/plugins/filter/ClearFilterConfirm.js","cb":false}]);
//end dojo save